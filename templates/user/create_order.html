{% extends "base.html" %}

{% block title %}Create New Order ‚Äî SmartPrint Pro{% endblock %}

{% block content %}

<style>
  .order-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }

  .order-header {
    background: linear-gradient(135deg, var(--purple) 0%, #571590 100%);
    color: white;
    padding: 28px 32px;
    border-radius: 12px;
    margin-bottom: 28px;
  }

  .order-header h1 {
    margin: 0 0 8px;
    font-size: 28px;
  }

  .card {
    background: white;
    padding: 28px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 24px;
  }

  .card h2 {
    margin: 0 0 20px;
    font-size: 20px;
    color: var(--purple);
    font-weight: 700;
  }

  .order-item {
    border: 2px solid #e8e6f2;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
  }

  .order-item.uploading {
    background: #faf9fc;
    border-color: var(--purple);
  }

  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .item-number {
    font-weight: 700;
    color: var(--purple);
    font-size: 16px;
  }

  .btn-remove-item {
    background: #fee;
    color: #c00;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--purple);
    font-size: 14px;
  }

  .form-group select,
  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e8e6f2;
    border-radius: 8px;
    font-size: 15px;
  }

  .form-group select:focus,
  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--purple);
    box-shadow: 0 0 0 3px rgba(107,33,168,0.1);
  }

  .upload-area {
    border: 2px dashed #e8e6f2;
    border-radius: 8px;
    padding: 24px;
    text-align: center;
    background: #faf9fc;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 12px;
  }

  .upload-area:hover {
    border-color: var(--purple);
    background: #f5f3f8;
  }

  .upload-area.has-file {
    border-color: #0a3622;
    background: #d1e7dd;
  }

  .file-info {
    display: none;
    margin-top: 12px;
    padding: 14px;
    background: linear-gradient(135deg, #e7f3ff 0%, #f0f9ff 100%);
    border-radius: 8px;
    border-left: 4px solid #0369a1;
    font-size: 13px;
    line-height: 1.6;
  }

  .file-info.visible {
    display: block;
  }
  
  .file-info strong {
    color: #0c4a6e;
  }

  .progress-bar {
    width: 100%;
    height: 6px;
    background: #e8e6f2;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
    display: none;
  }

  .progress-bar.active {
    display: block;
  }

  .progress-fill {
    height: 100%;
    background: var(--purple);
    width: 0%;
    transition: width 0.3s;
  }

  .price-display {
    text-align: right;
    font-size: 14px;
    color: var(--muted);
    margin-top: 12px;
  }

  .price-display strong {
    color: var(--purple);
    font-size: 18px;
  }

  .btn-add-item {
    background: #e8e6f2;
    color: var(--purple);
    border: 2px dashed var(--purple);
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    display: block;
    width: 100%;
    transition: all 0.2s;
  }

  .btn-add-item:hover {
    background: #d4d0e2;
  }

  .btn-add-item:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .order-summary {
    background: linear-gradient(135deg, #f5f3f8 0%, #faf9fc 100%);
    padding: 24px;
    border-radius: 12px;
    margin-top: 24px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 15px;
  }

  .summary-row.total {
    border-top: 2px solid var(--purple);
    padding-top: 12px;
    margin-top: 12px;
    font-weight: 700;
    font-size: 20px;
    color: var(--purple);
  }

  .btn-submit-order {
    background: var(--purple);
    color: white;
    border: none;
    padding: 16px 32px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    font-size: 16px;
    width: 100%;
    margin-top: 20px;
    transition: background 0.2s;
  }

  .btn-submit-order:hover {
    background: #571590;
  }

  .btn-submit-order:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .alert {
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
  }

  .alert-info {
    background: #cfe2ff;
    color: #084298;
    border-left: 4px solid #052c65;
  }

  .file-input {
    display: none;
  }
  
  .file-report {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #0ea5e9;
    border-radius: 12px;
    padding: 18px;
    margin-top: 16px;
    font-size: 13px;
    display: none;
    box-shadow: 0 2px 8px rgba(14, 165, 233, 0.1);
  }
  
  .file-report.visible {
    display: block;
  }
  
  .file-report h4 {
    margin: 0 0 14px;
    color: #0369a1;
    font-size: 15px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .file-report-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #bae6fd;
  }
  
  .file-report-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .file-report-label {
    font-weight: 600;
    color: #0c4a6e;
    flex: 0 0 45%;
  }
  
  .file-report-value {
    color: #0369a1;
    text-align: right;
    flex: 1;
    font-weight: 500;
  }
  
  .file-report-highlight {
    background: #fef3c7;
    border-left: 3px solid #f59e0b;
    padding: 10px 12px;
    margin-top: 10px;
    border-radius: 6px;
    color: #92400e;
    font-size: 12px;
  }
</style>

<div class="order-container">
  <div class="order-header">
    <h1>üìã Create New Order</h1>
    <p>Add up to 5 items to your order. Each item can have different specifications.</p>
  </div>

  <div class="alert alert-info">
    <strong>üí° Tip:</strong> Upload files for services that require them (documents, photos, custom designs). Prices shown are estimates and will be confirmed by staff.
  </div>

  <div class="card">
    <h2>Order Items</h2>
    
    <form id="orderForm" method="POST" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      
      <div id="orderItemsContainer">
        <!-- Order items will be added here dynamically -->
      </div>

      <button type="button" id="btnAddItem" class="btn-add-item" onclick="addOrderItem()">
        + Add Another Item (0/5)
      </button>

      <div class="form-group" style="margin-top: 24px;">
        <label for="customerNotes">Additional Notes (Optional)</label>
        <textarea id="customerNotes" name="customer_notes" rows="3" placeholder="Special instructions or requirements..."></textarea>
      </div>

      <div class="form-group" style="margin-top: 20px;">
        <label for="quoteDuration">Quote Deadline ‚è±Ô∏è</label>
        <select id="quoteDuration" name="quote_duration" required style="padding: 12px; border: 2px solid #e8e6f2; border-radius: 8px; font-size: 14px; width: 100%;">
          <option value="6">6 hours - Urgent (vendors have 6 hours to quote)</option>
          <option value="12">12 hours - Fast (vendors have 12 hours to quote)</option>
          <option value="24" selected>24 hours - Standard (vendors have 1 day to quote)</option>
          <option value="48">48 hours - Relaxed (vendors have 2 days to quote)</option>
          <option value="72">72 hours - Extended (vendors have 3 days to quote)</option>
        </select>
        <p style="font-size: 13px; color: var(--muted); margin: 8px 0 0;">‚ö†Ô∏è After this time, vendors can no longer submit quotes. Shorter deadlines may result in fewer quotes.</p>
      </div>

      <div class="order-summary">
        <h3 style="margin: 0 0 16px; color: var(--purple);">Order Summary</h3>
        <div class="summary-row">
          <span>Base Service Fee:</span>
          <span><strong>KSh 75.00</strong></span>
        </div>
        <div class="summary-row">
          <span>Items Subtotal:</span>
          <span id="subtotalAmount"><strong>KSh 0.00</strong></span>
        </div>
        <div class="summary-row total">
          <span>Total Amount:</span>
          <span id="totalAmount">KSh 75.00</span>
        </div>
        <p style="font-size: 13px; color: var(--muted); margin: 12px 0 0;">* Final price will be confirmed by staff after review</p>
      </div>

      <button type="submit" id="btnSubmitOrder" class="btn-submit-order">
        Submit Order
      </button>
    </form>
  </div>
</div>

<script>
  // @ts-nocheck
  const servicePrices = {{ services|tojson }};
  let itemCount = 0;
  const MAX_ITEMS = 5;
  const BASE_FEE = 75.00;

  // Add first item automatically on page load
  document.addEventListener('DOMContentLoaded', () => {
    addOrderItem();
  });

  function addOrderItem() {
    if (itemCount >= MAX_ITEMS) {
      alert('Maximum 5 items per order');
      return;
    }

    itemCount++;
    const itemId = 'item-' + itemCount;
    const currentCount = itemCount;
    
    // Build category options
    const categoryOptions = getUniqueCategories().map(function(cat) {
      return '<option value="' + cat + '">' + cat + '</option>';
    }).join('');
    
    // Build remove button HTML
    const removeButton = itemCount > 1 
      ? '<button type="button" class="btn-remove-item" onclick="removeOrderItem(\'' + itemId + '\')">Remove</button>' 
      : '';
    
    const itemHTML = 
      '<div class="order-item" id="' + itemId + '">' +
        '<div class="item-header">' +
          '<span class="item-number">Item #' + itemCount + '</span>' +
          removeButton +
        '</div>' +

        '<div class="form-row">' +
          '<div class="form-group">' +
            '<label for="' + itemId + '-category">Service Category *</label>' +
            '<select id="' + itemId + '-category" name="items[' + currentCount + '][category]" required onchange="updateServiceOptions(\'' + itemId + '\')">' +
              '<option value="">-- Select Category --</option>' +
              categoryOptions +
            '</select>' +
          '</div>' +

          '<div class="form-group">' +
            '<label for="' + itemId + '-service">Service Type *</label>' +
            '<select id="' + itemId + '-service" name="items[' + currentCount + '][service]" required onchange="updatePrice(\'' + itemId + '\')">' +
              '<option value="">-- Select Service --</option>' +
            '</select>' +
          '</div>' +

          '<div class="form-group">' +
            '<label for="' + itemId + '-quantity">Quantity *</label>' +
            '<input type="number" id="' + itemId + '-quantity" name="items[' + currentCount + '][quantity]" min="1" value="1" required onchange="updatePrice(\'' + itemId + '\')">' +
          '</div>' +
        '</div>' +

        '<div class="form-group">' +
          '<label for="' + itemId + '-file">Upload File (if required)</label>' +
          '<input type="file" id="' + itemId + '-file" name="items[' + currentCount + '][file]" class="file-input" accept=".pdf,.docx,.doc,.png,.jpg,.jpeg,.gif,.bmp,.svg,.psd,.ai,.eps,.txt,.xlsx,.xls,.csv,.ppt,.pptx,.zip" onchange="handleFileSelect(\'' + itemId + '\')">' +
          '<div class="upload-area" id="' + itemId + '-upload" onclick="document.getElementById(\'' + itemId + '-file\').click()">' +
            '<div>üì§ Click to upload file</div>' +
            '<small style="color: #6b6b77; margin-top: 8px; display: block;">PDF, Word, Images, Design Files (Max 50MB)</small>' +
          '</div>' +
          '<div id="' + itemId + '-progress" class="progress-bar">' +
            '<div class="progress-fill"></div>' +
          '</div>' +
          '<div id="' + itemId + '-fileinfo" class="file-info"></div>' +
          '<div id="' + itemId + '-report" class="file-report"></div>' +
        '</div>' +

        '<div class="form-group">' +
          '<label for="' + itemId + '-specs">Additional Specifications</label>' +
          '<textarea id="' + itemId + '-specs" name="items[' + currentCount + '][specifications]" rows="2" placeholder="e.g., Paper type, colors, sizes, finishing options..."></textarea>' +
        '</div>' +

        '<div class="price-display" id="' + itemId + '-price">' +
          'Estimated Price: <strong>KSh 0.00</strong>' +
        '</div>' +
      '</div>';

    document.getElementById('orderItemsContainer').insertAdjacentHTML('beforeend', itemHTML);
    updateAddButton();
  }

  function removeOrderItem(itemId) {
    document.getElementById(itemId).remove();
    itemCount--;
    updateAddButton();
    updateOrderTotal();
    renumberItems();
  }

  function renumberItems() {
    const items = document.querySelectorAll('.order-item');
    items.forEach((item, index) => {
      const itemNumber = item.querySelector('.item-number');
      if (itemNumber) {
        itemNumber.textContent = `Item #${index + 1}`;
      }
    });
  }

  function updateAddButton() {
    const btn = document.getElementById('btnAddItem');
    btn.textContent = '+ Add Another Item (' + itemCount + '/' + MAX_ITEMS + ')';
    btn.disabled = itemCount >= MAX_ITEMS;
  }

  function getUniqueCategories() {
    const categories = servicePrices.map(function(s) {
      return s.category;
    });
    return categories.filter(function(value, index, self) {
      return self.indexOf(value) === index;
    });
  }

  function updateServiceOptions(itemId) {
    const categorySelect = document.getElementById(itemId + '-category');
    const serviceSelect = document.getElementById(itemId + '-service');
    const selectedCategory = categorySelect.value;

    serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';

    if (selectedCategory) {
      const services = servicePrices.filter(function(s) {
        return s.category === selectedCategory;
      });
      services.forEach(function(service) {
        const option = document.createElement('option');
        option.value = service.id;
        option.textContent = service.service_name + ' (KSh ' + service.average_price + ' ' + service.unit + ')';
        option.dataset.price = service.average_price;
        option.dataset.unit = service.unit;
        serviceSelect.appendChild(option);
      });
    }

    updatePrice(itemId);
  }

  function updatePrice(itemId) {
    const serviceSelect = document.getElementById(itemId + '-service');
    const quantityInput = document.getElementById(itemId + '-quantity');
    const priceDisplay = document.getElementById(itemId + '-price');

    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
    const unitPrice = parseFloat(selectedOption && selectedOption.dataset && selectedOption.dataset.price ? selectedOption.dataset.price : 0);
    const quantity = parseInt(quantityInput.value) || 1;
    
    // Get file analysis data if available
    const fileAnalysis = window[`${itemId}_analysis`] || {};
    let priceMultiplier = 1;
    let priceAdjustments = [];
    
    // Apply pricing adjustments based on file analysis
    if (fileAnalysis.pageCount) {
      // For documents, multiply by page count
      priceMultiplier = fileAnalysis.pageCount;
      priceAdjustments.push(`${fileAnalysis.pageCount} pages`);
    }
    
    if (fileAnalysis.isHighResolution) {
      // High resolution images cost more for processing
      priceMultiplier *= 1.2;
      priceAdjustments.push('high-res +20%');
    }
    
    if (fileAnalysis.isLowResolution) {
      // Low resolution may need enhancement
      priceMultiplier *= 1.1;
      priceAdjustments.push('quality enhancement +10%');
    }
    
    if (fileAnalysis.isImageRich) {
      // Image-rich documents cost more
      priceMultiplier *= 1.15;
      priceAdjustments.push('image-rich +15%');
    }
    
    if (fileAnalysis.requiresConversion) {
      // Files needing conversion cost slightly more
      priceMultiplier *= 1.05;
      priceAdjustments.push('conversion +5%');
    }
    
    const adjustedPrice = unitPrice * priceMultiplier;
    const total = adjustedPrice * quantity;
    
    let priceHTML = 'Estimated Price: <strong>KSh ' + total.toFixed(2) + '</strong>';
    if (priceAdjustments.length > 0) {
      priceHTML += '<br><small style="color: #666; font-size: 12px;">Adjustments: ' + priceAdjustments.join(', ') + '</small>';
    }
    
    priceDisplay.innerHTML = priceHTML;
    
    updateOrderTotal();
  }

  function updateOrderTotal() {
    let subtotal = 0;
    
    document.querySelectorAll('.order-item').forEach(function(item) {
      const itemId = item.id;
      const serviceSelect = document.getElementById(itemId + '-service');
      const quantityInput = document.getElementById(itemId + '-quantity');
      
      const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
      const unitPrice = parseFloat(selectedOption && selectedOption.dataset && selectedOption.dataset.price ? selectedOption.dataset.price : 0);
      const quantity = parseInt(quantityInput.value) || 1;
      
      // Get file analysis data if available
      const fileAnalysis = window[`${itemId}_analysis`] || {};
      let priceMultiplier = 1;
      
      // Apply same pricing adjustments as updatePrice
      if (fileAnalysis.pageCount) {
        priceMultiplier = fileAnalysis.pageCount;
      }
      if (fileAnalysis.isHighResolution) {
        priceMultiplier *= 1.2;
      }
      if (fileAnalysis.isLowResolution) {
        priceMultiplier *= 1.1;
      }
      if (fileAnalysis.isImageRich) {
        priceMultiplier *= 1.15;
      }
      if (fileAnalysis.requiresConversion) {
        priceMultiplier *= 1.05;
      }
      
      const adjustedPrice = unitPrice * priceMultiplier;
      subtotal += (adjustedPrice * quantity);
    });

    const total = BASE_FEE + subtotal;

    document.getElementById('subtotalAmount').innerHTML = '<strong>KSh ' + subtotal.toFixed(2) + '</strong>';
    document.getElementById('totalAmount').textContent = 'KSh ' + total.toFixed(2);
  }

  function handleFileSelect(itemId) {
    const fileInput = document.getElementById(itemId + '-file');
    const uploadArea = document.getElementById(itemId + '-upload');
    const fileInfo = document.getElementById(itemId + '-fileinfo');
    const progressBar = document.getElementById(itemId + '-progress');
    const progressFill = progressBar.querySelector('.progress-fill');
    const reportDiv = document.getElementById(itemId + '-report');
    const file = fileInput.files[0];

    if (!file) return;

    // Validate file size
    if (file.size > 50 * 1024 * 1024) {
      alert('File too large. Maximum size is 50MB.');
      fileInput.value = '';
      return;
    }

    // Show progress bar
    progressBar.classList.add('active');
    progressFill.style.width = '0%';

    // Simulate upload progress
    let progress = 0;
    const progressInterval = setInterval(function() {
      progress += 10;
      progressFill.style.width = progress + '%';
      
      if (progress >= 100) {
        clearInterval(progressInterval);
        setTimeout(function() {
          progressBar.classList.remove('active');
          progressFill.style.width = '0%';
        }, 500);
      }
    }, 100);

    // Update upload area
    uploadArea.classList.add('has-file');
    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
    const fileTypeDisplay = file.name.split('.').pop().toUpperCase();
    uploadArea.innerHTML = '<div>‚úÖ ' + file.name + '</div><small style="color: #6b6b77;">' + fileSizeMB + ' MB ‚Ä¢ ' + fileTypeDisplay + ' File</small>';
    
    // Show enhanced file info immediately
    fileInfo.classList.add('visible');
    const lastModified = new Date(file.lastModified).toLocaleDateString() + ' ' + new Date(file.lastModified).toLocaleTimeString();
    fileInfo.innerHTML = '<strong>üìé File selected:</strong> ' + file.name + '<br>' +
                        '<strong>Size:</strong> ' + formatFileSize(file.size) + ' ‚Ä¢ ' +
                        '<strong>Type:</strong> ' + file.type + ' ‚Ä¢ ' +
                        '<strong>Modified:</strong> ' + lastModified;

    // Extract detailed file attributes
    extractFileAttributes(file, itemId);
  }

  async function extractFileAttributes(file, itemId) {
    const reportDiv = document.getElementById(`${itemId}-report`);
    const fileType = file.name.split('.').pop().toLowerCase();
    
    // Initialize analysis data for pricing
    const analysisData = {
      pageCount: 0,
      isHighResolution: false,
      isLowResolution: false,
      isImageRich: false,
      requiresConversion: false
    };
    
    // Get file modification date
    const lastModified = new Date(file.lastModified);
    const formattedDate = lastModified.toLocaleDateString() + ' ' + lastModified.toLocaleTimeString();
    
    let reportHTML = '<h4>üìä File Analysis Report</h4>';
    reportHTML += '<div class="file-report-row"><span class="file-report-label">File Name:</span><span class="file-report-value">' + file.name + '</span></div>';
    reportHTML += '<div class="file-report-row"><span class="file-report-label">File Size:</span><span class="file-report-value">' + formatFileSize(file.size) + '</span></div>';
    reportHTML += '<div class="file-report-row"><span class="file-report-label">File Type:</span><span class="file-report-value">' + fileType.toUpperCase() + ' (' + file.type + ')</span></div>';
    reportHTML += '<div class="file-report-row"><span class="file-report-label">Last Modified:</span><span class="file-report-value">' + formattedDate + '</span></div>';

    if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp'].includes(fileType)) {
      // Extract image dimensions and metadata
      try {
        const img = new Image();
        const imageUrl = URL.createObjectURL(file);
        
        img.onload = function() {
          const width = img.width;
          const height = img.height;
          const aspectRatio = (width / height).toFixed(2);
          const megapixels = ((width * height) / 1000000).toFixed(2);
          
          // Determine print sizes (assuming 300 DPI for high quality)
          const printWidthInches = (width / 300).toFixed(2);
          const printHeightInches = (height / 300).toFixed(2);
          const printWidthCm = (width / 300 * 2.54).toFixed(1);
          const printHeightCm = (height / 300 * 2.54).toFixed(1);
          
          // Determine orientation
          const orientation = width > height ? 'üìê Landscape' : width < height ? 'üì± Portrait' : '‚¨ú Square';
          
          // Determine quality category based on dimensions
          let quality = '‚≠ê Standard Quality';
          let qualityNote = 'Suitable for screen display';
          if (width >= 4000 && height >= 3000) {
            quality = 'üåü Professional Quality';
            qualityNote = 'Excellent for large format printing';
            analysisData.isHighResolution = true;
          } else if (width >= 3000 && height >= 3000) {
            quality = '‚ú® High Resolution';
            qualityNote = 'Great for poster-sized prints';
            analysisData.isHighResolution = true;
          } else if (width >= 1920 && height >= 1080) {
            quality = '‚≠ê HD Quality';
            qualityNote = 'Good for medium prints up to A4';
          } else if (width < 800 || height < 600) {
            quality = '‚ö†Ô∏è Low Resolution';
            qualityNote = 'May appear pixelated when printed';
            analysisData.isLowResolution = true;
          }
          
          // Suggest DPI for different print sizes
          let dpiRecommendation = '';
          if (width < 1200 && height < 900) {
            dpiRecommendation = '<div class="file-report-highlight">‚ö†Ô∏è <strong>Notice:</strong> This image may not print well at sizes larger than 4√ó6 inches. For better quality, use a higher resolution image.</div>';
          } else if (width >= 3000) {
            dpiRecommendation = '<div class="file-report-highlight" style="background: #d1fae5; border-left-color: #10b981; color: #064e3b;">‚úì <strong>Excellent:</strong> This image has sufficient resolution for high-quality prints up to poster size!</div>';
          }
          
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üìè Width:</span><span class="file-report-value">' + width.toLocaleString() + ' px</span></div>';
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üìè Height:</span><span class="file-report-value">' + height.toLocaleString() + ' px</span></div>';
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üìê Dimensions:</span><span class="file-report-value">' + width.toLocaleString() + ' √ó ' + height.toLocaleString() + ' pixels</span></div>';
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üéØ Megapixels:</span><span class="file-report-value">' + megapixels + ' MP</span></div>';
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üìä Aspect Ratio:</span><span class="file-report-value">' + aspectRatio + ':1</span></div>';
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üîÑ Orientation:</span><span class="file-report-value">' + orientation + '</span></div>';
          reportHTML += '<div class="file-report-row"><span class="file-report-label">‚ú® Quality:</span><span class="file-report-value">' + quality + '</span></div>';
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üìù Best Use:</span><span class="file-report-value">' + qualityNote + '</span></div>';
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üñ®Ô∏è Print @ 300 DPI:</span><span class="file-report-value">' + printWidthInches + '" √ó ' + printHeightInches + '" (' + printWidthCm + ' √ó ' + printHeightCm + ' cm)</span></div>';
          
          // Calculate print size at 150 DPI for larger prints
          const printWidth150 = (width / 150).toFixed(1);
          const printHeight150 = (height / 150).toFixed(1);
          reportHTML += '<div class="file-report-row"><span class="file-report-label">üñºÔ∏è Print @ 150 DPI:</span><span class="file-report-value">' + printWidth150 + '" √ó ' + printHeight150 + '" (poster quality)</span></div>';
          
          // Suggest standard photo sizes
          const standardSizes = suggestPhotoSizes(width, height);
          if (standardSizes.length > 0) {
            reportHTML += '<div class="file-report-row"><span class="file-report-label">üì∏ Recommended Sizes:</span><span class="file-report-value">' + standardSizes.join(', ') + '</span></div>';
          }
          
          // Add quality recommendation box
          reportHTML += dpiRecommendation;
          
          reportDiv.innerHTML = reportHTML;
          reportDiv.classList.add('visible');
          
          // Store analysis data and update price
          window[`${itemId}_analysis`] = analysisData;
          updatePrice(itemId);
          
          URL.revokeObjectURL(imageUrl);
        };
        
        img.onerror = function() {
          reportHTML += '<div class="file-report-row"><span class="file-report-label">Note:</span><span class="file-report-value">Unable to analyze image properties</span></div>';
          reportDiv.innerHTML = reportHTML;
          reportDiv.classList.add('visible');
          URL.revokeObjectURL(imageUrl);
        };
        
        img.src = imageUrl;
      } catch (error) {
        console.error('Error extracting image attributes:', error);
        reportDiv.innerHTML = reportHTML;
        reportDiv.classList.add('visible');
      }
    } else if (fileType === 'pdf') {
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üìÑ Document Type:</span><span class="file-report-value">PDF Document</span></div>';
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üè∑Ô∏è MIME Type:</span><span class="file-report-value">' + file.type + '</span></div>';
      
      // Estimate page count based on file size (rough estimate: 50-100KB per page)
      const estimatedPagesMin = Math.ceil(file.size / 100000);
      const estimatedPagesMax = Math.ceil(file.size / 50000);
      const estimatedPages = Math.ceil(file.size / 75000);
      
      // Store page count for pricing
      analysisData.pageCount = estimatedPages;
      
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üìë Est. Page Count:</span><span class="file-report-value">~' + estimatedPages + ' page(s) (' + estimatedPagesMin + '-' + estimatedPagesMax + ' range)</span></div>';
      
      // Calculate estimated printing cost
      const estimatedCost = estimatedPages * 5; // Assuming ~5 KSh per page
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üí∞ Est. Print Cost:</span><span class="file-report-value">~KSh ' + estimatedCost.toLocaleString() + ' (B&W, single-sided)</span></div>';
      
      // File size per page indicator
      const sizePerPage = (file.size / estimatedPages / 1024).toFixed(0);
      let contentType = 'Text-heavy';
      if (sizePerPage > 200) {
        contentType = 'Image-rich (graphics/photos)';
        analysisData.isImageRich = true;
      } else if (sizePerPage > 100) {
        contentType = 'Mixed (text & images)';
      }
      
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üìä Content Type:</span><span class="file-report-value">' + contentType + '</span></div>';
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üìè Avg Size/Page:</span><span class="file-report-value">' + sizePerPage + ' KB</span></div>';
      
      reportHTML += '<div class="file-report-highlight">‚ÑπÔ∏è <strong>Note:</strong> Exact page count and specifications will be determined after upload. Color pages may cost more.</div>';
      
      reportDiv.innerHTML = reportHTML;
      reportDiv.classList.add('visible');
      
      // Store analysis data and update price
      window[`${itemId}_analysis`] = analysisData;
      updatePrice(itemId);
      
    } else if (fileType === 'docx' || fileType === 'doc') {
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üìù Document Type:</span><span class="file-report-value">Microsoft Word Document</span></div>';
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üè∑Ô∏è MIME Type:</span><span class="file-report-value">' + file.type + '</span></div>';
      
      // Estimate page count (Word docs typically 30-60KB per page)
      const estimatedPagesMin = Math.ceil(file.size / 60000);
      const estimatedPagesMax = Math.ceil(file.size / 30000);
      const estimatedPages = Math.ceil(file.size / 45000);
      
      // Store page count and mark as requiring conversion
      analysisData.pageCount = estimatedPages;
      analysisData.requiresConversion = true;
      
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üìë Est. Page Count:</span><span class="file-report-value">~' + estimatedPages + ' page(s) (' + estimatedPagesMin + '-' + estimatedPagesMax + ' range)</span></div>';
      
      // Calculate estimated printing cost
      const estimatedCost = estimatedPages * 5;
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üí∞ Est. Print Cost:</span><span class="file-report-value">~KSh ' + estimatedCost.toLocaleString() + ' (after PDF conversion)</span></div>';
      
      // File complexity indicator
      const sizePerPage = (file.size / estimatedPages / 1024).toFixed(0);
      let complexity = 'Simple text';
      if (sizePerPage > 150) complexity = 'Rich formatting (tables, images)';
      else if (sizePerPage > 80) complexity = 'Moderate formatting';
      
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üìä Document Style:</span><span class="file-report-value">' + complexity + '</span></div>';
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üìè Avg Size/Page:</span><span class="file-report-value">' + sizePerPage + ' KB</span></div>';
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üîÑ Processing:</span><span class="file-report-value">Will be converted to PDF format</span></div>';
      
      reportHTML += '<div class="file-report-highlight">‚ÑπÔ∏è <strong>Note:</strong> Document will be converted to PDF for printing. Ensure fonts and images are embedded properly.</div>';
      
      reportDiv.innerHTML = reportHTML;
      reportDiv.classList.add('visible');
      
      // Store analysis data and update price
      window[`${itemId}_analysis`] = analysisData;
      updatePrice(itemId);
      
    } else {
      // Generic file type - try to provide useful information
      reportHTML += '<div class="file-report-row"><span class="file-report-label">üè∑Ô∏è MIME Type:</span><span class="file-report-value">' + (file.type || 'Unknown') + '</span></div>';
      
      // Check for specific file types and provide relevant info
      if (fileType === 'svg') {
        analysisData.requiresConversion = true;
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìä Vector Format:</span><span class="file-report-value">Scalable Vector Graphics</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">‚ú® Advantage:</span><span class="file-report-value">Can be scaled to any size without quality loss</span></div>';
        reportHTML += '<div class="file-report-highlight" style="background: #d1fae5; border-left-color: #10b981; color: #064e3b;">‚úì <strong>Perfect for:</strong> Logos, banners, and large format printing!</div>';
      } else if (fileType === 'ai' || fileType === 'eps' || fileType === 'cdr') {
        analysisData.requiresConversion = true;
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üé® Design File:</span><span class="file-report-value">Professional design format</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üíº Software:</span><span class="file-report-value">' + (fileType === 'ai' ? 'Adobe Illustrator' : fileType === 'cdr' ? 'CorelDRAW' : 'PostScript') + '</span></div>';
        reportHTML += '<div class="file-report-highlight">‚ÑπÔ∏è <strong>Note:</strong> This file requires specialized software to process. Vendor will review compatibility.</div>';
      } else if (fileType === 'psd') {
        analysisData.requiresConversion = true;
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üé® Design File:</span><span class="file-report-value">Adobe Photoshop Document</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìê Format:</span><span class="file-report-value">Layered image file</span></div>';
        reportHTML += '<div class="file-report-highlight">‚ÑπÔ∏è <strong>Note:</strong> File may be flattened before printing. Ensure all layers are finalized.</div>';
      } else if (fileType === 'txt') {
        const estimatedChars = file.size;
        const estimatedPages = Math.ceil(estimatedChars / 3000); // ~3000 chars per page
        analysisData.pageCount = estimatedPages;
        analysisData.requiresConversion = true;
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìù Text File:</span><span class="file-report-value">Plain text document</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìè Characters:</span><span class="file-report-value">~' + estimatedChars.toLocaleString() + '</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìë Est. Pages:</span><span class="file-report-value">~' + estimatedPages + ' (standard formatting)</span></div>';
      } else if (fileType === 'zip' || fileType === 'rar' || fileType === '7z') {
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üì¶ Archive File:</span><span class="file-report-value">Compressed folder</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìÇ Contains:</span><span class="file-report-value">Multiple files (will be extracted)</span></div>';
        reportHTML += '<div class="file-report-highlight">‚ÑπÔ∏è <strong>Note:</strong> Archive will be extracted by vendor. Ensure all necessary files are included.</div>';
      } else if (['xlsx', 'xls', 'csv'].includes(fileType)) {
        analysisData.requiresConversion = true;
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìä Spreadsheet:</span><span class="file-report-value">' + (fileType === 'csv' ? 'CSV Data' : 'Excel Workbook') + '</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üîÑ Processing:</span><span class="file-report-value">Will be converted to PDF for printing</span></div>';
        reportHTML += '<div class="file-report-highlight">‚ö†Ô∏è <strong>Notice:</strong> Ensure data fits page layout. Wide spreadsheets may need adjustment.</div>';
      } else if (['ppt', 'pptx'].includes(fileType)) {
        const estimatedSlides = Math.ceil(file.size / 100000);
        analysisData.pageCount = estimatedSlides;
        analysisData.requiresConversion = true;
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìΩÔ∏è Presentation:</span><span class="file-report-value">PowerPoint Slides</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìë Est. Slides:</span><span class="file-report-value">~' + estimatedSlides + '</span></div>';
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üîÑ Processing:</span><span class="file-report-value">Will be converted to PDF</span></div>';
      } else {
        reportHTML += '<div class="file-report-row"><span class="file-report-label">üìã Status:</span><span class="file-report-value">Custom file type</span></div>';
        reportHTML += '<div class="file-report-highlight">‚ÑπÔ∏è <strong>Note:</strong> File will be reviewed by vendor to determine compatibility and printing requirements.</div>';
      }
      
      reportDiv.innerHTML = reportHTML;
      reportDiv.classList.add('visible');
      
      // Store analysis data and update price for all file types
      window[`${itemId}_analysis`] = analysisData;
      updatePrice(itemId);
    }
  }
  
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / 1024 / 1024).toFixed(2) + ' MB';
  }
  
  function suggestPhotoSizes(width, height) {
    const sizes = [];
    const aspectRatio = width / height;
    
    // Standard photo sizes with their aspect ratios
    const standards = [
      { name: '4√ó6"', ratio: 1.5, minWidth: 1200 },
      { name: '5√ó7"', ratio: 1.4, minWidth: 1500 },
      { name: '8√ó10"', ratio: 1.25, minWidth: 2400 },
      { name: '11√ó14"', ratio: 1.27, minWidth: 3300 },
      { name: 'A4', ratio: 1.41, minWidth: 2480 },
      { name: 'A3', ratio: 1.41, minWidth: 3508 },
      { name: '16√ó20"', ratio: 1.25, minWidth: 4800 },
      { name: 'Square (1:1)', ratio: 1.0, minWidth: 1000 }
    ];
    
    standards.forEach(std => {
      const ratioDiff = Math.abs(aspectRatio - std.ratio);
      if (ratioDiff < 0.15 && width >= std.minWidth) {
        sizes.push(std.name);
      }
    });
    
    return sizes;
  }

  document.getElementById('orderForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('btnSubmitOrder');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing Order...';

    const formData = new FormData(this);

    try {
      const response = await fetch('/create-order', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok) {
        alert('‚úÖ Order created successfully!');
        window.location.href = '/dashboard';
      } else {
        alert('‚ùå Error: ' + (result.error || 'Failed to create order'));
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Order';
      }
    } catch (error) {
      alert('‚ùå Error creating order. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Order';
    }
  });
</script>
{% endblock %}
