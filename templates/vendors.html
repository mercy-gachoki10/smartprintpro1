{% extends "base.html" %}

{% block title %}Find Local Print Vendors in Kenya ‚Äî SmartPrint Pro{% endblock %}

{% block content %}
  <!-- HERO -->
  <section class="hero">
    <h1>Print Vendors Across Kenya</h1>
    <p>Discover trusted local print shops in Nairobi, Mombasa, Kisumu and beyond. Filter by location, specialization, and ratings.</p>

    <div class="searchBox">
      <input id="q" aria-label="Search vendors" placeholder="Search by name, location, or service..." />
      <button id="searchBtn" aria-label="Search button">Search</button>
    </div>
  </section>

  <!-- MAIN VENDORS LIST -->
  <main class="container">
    <h3 style="color:var(--purple)">All Vendors</h3>
    
    {% if vendors and vendors|length > 0 %}
    <div id="vendors" class="grid" style="margin-top:12px">
      {% for v in vendors %}
      {# Set background colors array and calculate index #}
      {% set bg_colors = ['#c9f1ff', '#f2e2b2', '#ffe5b4', '#d4d4ff', '#ffd4d4', '#e5d4ff'] %}
      {% set color_index = loop.index0 % 6 %}
      {% set vendor_bg = bg_colors[color_index] %}
      <div class="vendor" data-tags="{{ v.service_tags }},{{ v.vendor.business_address|lower if v.vendor.business_address else '' }}" aria-label="{{ v.vendor.business_name }} vendor">
        <div>
          <div class="title">
            <div class="logoSmall" style="background:{{ vendor_bg }};color:#000;">
              {{ v.vendor.business_name[:2].upper() }}
            </div>
            <div>
              <h4>{{ v.vendor.business_name }} 
                {% if v.completed_orders > 100 %}
                <span style="font-size:12px;color:var(--muted)">(Premium)</span>
                {% endif %}
              </h4>
              <div style="color:var(--muted);font-size:13px">
                üìç {{ v.vendor.business_address if v.vendor.business_address else 'Kenya' }}
              </div>
            </div>
          </div>
          
          <div style="margin-top:8px;font-size:13px">
            {% if v.services %}
              {{ v.services|join(' ‚Ä¢ ') }}
            {% else %}
              General Printing Services
            {% endif %}
          </div>
          
          <div class="meta">
            Rating: 
            {% if v.avg_rating >= 4.5 %}‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            {% elif v.avg_rating >= 3.5 %}‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ
            {% elif v.avg_rating >= 2.5 %}‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ
            {% elif v.avg_rating >= 1.5 %}‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ
            {% elif v.avg_rating > 0 %}‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ
            {% else %}No ratings yet
            {% endif %}
            
            {% if v.completed_orders > 0 %}
              ‚Ä¢ {{ v.completed_orders }} order{{ 's' if v.completed_orders != 1 else '' }}
            {% endif %}
            
            {% if v.completed_orders > 200 %}
              ‚Ä¢ Fast delivery
            {% elif v.completed_orders > 100 %}
              ‚Ä¢ Premium quality
            {% endif %}
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="viewBtn" onclick="viewShop('{{ v.vendor.business_name|replace("'", "\\'") }}', {{ v.vendor.id }})">View Profile</button>
          <button class="visitBtn" onclick="openContact('{{ v.vendor.business_name|replace("'", "\\'") }}', '{{ v.vendor.email }}', '{{ v.vendor.phone }}')">Contact</button>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align:center;padding:40px;color:var(--muted)">
      <p style="font-size:18px">üîç No vendors registered yet.</p>
      <p>Check back soon as we onboard print shops across Kenya!</p>
    </div>
    {% endif %}

    <!-- VENDOR STATS -->
    <section id="stats" style="margin-top:40px;background:linear-gradient(135deg, var(--purple), #571590);color:#fff;padding:32px;border-radius:12px;text-align:center">
      <h3>SmartPrint Pro Coverage in Kenya</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:20px;margin-top:20px">
        <div>
          <div style="font-size:28px;font-weight:800">{{ vendors|length if vendors else 0 }}+</div>
          <div style="opacity:0.9">Vendors nationwide</div>
        </div>
        <div>
          <div style="font-size:28px;font-weight:800">15+</div>
          <div style="opacity:0.9">Cities covered</div>
        </div>
        <div>
          <div style="font-size:28px;font-weight:800">
            {% set total_orders = namespace(count=0) %}
            {% for v in vendors %}
              {% set total_orders.count = total_orders.count + v.completed_orders %}
            {% endfor %}
            {{ total_orders.count if vendors else 0 }}+
          </div>
          <div style="opacity:0.9">Successful orders</div>
        </div>
        <div>
          <div style="font-size:28px;font-weight:800">24-48hrs</div>
          <div style="opacity:0.9">Average turnaround</div>
        </div>
      </div>
    </section>

  </main>

  {% block extra_js %}
  <script>
    // search filter for vendor cards
    const qInput = document.getElementById('q');
    const searchBtn = document.getElementById('searchBtn');
    
    if (searchBtn && qInput) {
      searchBtn.addEventListener('click', filterVendors);
      qInput.addEventListener('input', filterVendors);
      qInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          filterVendors();
        }
      });
    }

    function filterVendors(){
      const query = qInput.value.trim().toLowerCase();
      const vendorCards = document.querySelectorAll('.vendor');
      let visibleCount = 0;
      
      vendorCards.forEach(card => {
        const tags = (card.dataset.tags || '').toLowerCase();
        const text = card.innerText.toLowerCase();
        const match = query === '' || tags.includes(query) || text.includes(query);
        
        if (match) {
          card.style.display = '';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      // Show "no results" message if nothing matches
      let noResultsMsg = document.getElementById('noResultsMsg');
      if (visibleCount === 0 && query !== '') {
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.id = 'noResultsMsg';
          noResultsMsg.style.cssText = 'text-align:center;padding:40px;color:var(--muted);grid-column:1/-1;';
          noResultsMsg.innerHTML = '<p style="font-size:18px">üîç No vendors found matching "' + query + '"</p><p>Try searching for a different location or service.</p>';
          document.getElementById('vendors').appendChild(noResultsMsg);
        }
      } else if (noResultsMsg) {
        noResultsMsg.remove();
      }
    }

    // view shop (navigate to vendor profile)
    function viewShop(name, vendorId){
      window.location.href = '/vendor/' + vendorId;
    }

    // open contact info
    function openContact(name, email, phone){
      const message = 'Contact ' + name + ':\n\n' +
                     'üìß Email: ' + email + '\n' +
                     'üì± Phone: ' + phone + '\n\n' +
                     'You can reach out directly to discuss your printing needs.';
      alert(message);
    }
  </script>
  {% endblock %}
{% endblock %}
