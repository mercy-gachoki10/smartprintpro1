{% extends "base.html" %}

{% block title %}Order {{ order.order_number }} ‚Äî SmartPrint Pro{% endblock %}

{% block content %}
<section class="order-detail-container">
  <div class="order-header-section">
    <div>
      <h1>Order {{ order.order_number }}</h1>
      <span class="badge badge-{{ order.status }}">{{ order.status|replace('_', ' ')|title }}</span>
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
  </div>

  <div class="order-grid">
    <!-- Order Information -->
    <div class="card">
      <h2>Order Information</h2>
      <div class="info-row">
        <span class="label">Order Number:</span>
        <span class="value">{{ order.order_number }}</span>
      </div>
      <div class="info-row">
        <span class="label">Created:</span>
        <span class="value">{{ order.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
      </div>
      <div class="info-row">
        <span class="label">Status:</span>
        <span class="value">{{ order.status|replace('_', ' ')|title }}</span>
      </div>
      <div class="info-row">
        <span class="label">Total Amount:</span>
        <span class="value">KSh {{ "{:,.2f}".format(order.total_amount) }}</span>
      </div>
    </div>

    <!-- Customer Information -->
    <div class="card">
      <h2>Customer Details</h2>
      <div class="info-row">
        <span class="label">Name:</span>
        <span class="value">{{ order.customer.full_name }}</span>
      </div>
      <div class="info-row">
        <span class="label">Email:</span>
        <span class="value">{{ order.customer.email }}</span>
      </div>
      <div class="info-row">
        <span class="label">Phone:</span>
        <span class="value">{{ order.customer.phone }}</span>
      </div>
      {% if order.customer_notes %}
      <div class="info-row">
        <span class="label">Notes:</span>
        <span class="value">{{ order.customer_notes }}</span>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Order Items -->
  <div class="card">
    <h2>Order Items</h2>
    <div class="items-table">
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Type</th>
            <th>Quantity</th>
            <th>Unit Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for item in order.order_items %}
          <tr>
            <td>{{ item.service_category }}</td>
            <td>{{ item.service_type }}</td>
            <td>{{ item.quantity }}</td>
            <td>KSh {{ "{:,.2f}".format(item.unit_price) }}</td>
            <td>KSh {{ "{:,.2f}".format(item.total_price) }}</td>
          </tr>
          {% if item.specifications %}
          <tr class="spec-row">
            <td colspan="5">
              <strong>Specifications:</strong> {{ item.specifications }}
            </td>
          </tr>
          {% endif %}
          {% if item.file_name %}
          <tr class="spec-row">
            <td colspan="5">
              <strong>File:</strong> {{ item.file_name }}
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" style="text-align: right;"><strong>Base Fee:</strong></td>
            <td><strong>KSh {{ "{:,.2f}".format(order.base_fee) }}</strong></td>
          </tr>
          <tr>
            <td colspan="4" style="text-align: right;"><strong>Subtotal:</strong></td>
            <td><strong>KSh {{ "{:,.2f}".format(order.subtotal) }}</strong></td>
          </tr>
          <tr class="total-row">
            <td colspan="4" style="text-align: right;"><strong>Total:</strong></td>
            <td><strong>KSh {{ "{:,.2f}".format(order.total_amount) }}</strong></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Actions -->
  <div class="card">
    <h2>Actions</h2>
    <div class="action-buttons">
      {% if order.quotes_open %}
      <a href="{{ url_for('vendor_submit_quote', order_id=order.id) }}" class="btn btn-primary">
        {% if order.get_vendor_quote_count(current_user.id) > 0 %}
          Revise Quote
        {% else %}
          Submit Quote
        {% endif %}
      </a>
      {% elif order.vendor_id == current_user.id %}
        <!-- Order Processing Workflow -->
        <div class="processing-workflow">
          <h3 style="margin-bottom: 20px; color: var(--purple);">üìã Order Processing</h3>
          
          <!-- Current Status Card -->
          <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #f5f3f8 0%, #faf9fc 100%); border-radius: 12px; border-left: 4px solid var(--purple);">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 32px;">
                {% if order.status == 'in_progress' %}üì•
                {% elif order.status == 'confirmed_received' %}‚úÖ
                {% elif order.status == 'processing' %}üñ®Ô∏è
                {% elif order.status == 'finished' %}‚úîÔ∏è
                {% elif order.status == 'quality_check' %}üîç
                {% elif order.status == 'ready_dispatch' %}üì¶
                {% elif order.status == 'dispatched' %}üöö
                {% elif order.status == 'awaiting_payment' %}üí∞
                {% elif order.status == 'completed' %}üéâ
                {% endif %}
              </div>
              <div>
                <div style="font-weight: 700; font-size: 16px; color: var(--purple); margin-bottom: 4px;">
                  {{ order.status.replace('_', ' ').title() }}
                </div>
                <div style="font-size: 13px; color: var(--muted);">
                  {% if order.status == 'in_progress' %}Click below to confirm receipt and start processing
                  {% elif order.status == 'confirmed_received' %}Ready to begin production
                  {% elif order.status == 'processing' %}Order is being produced
                  {% elif order.status == 'finished' %}Production completed, ready for QC
                  {% elif order.status == 'quality_check' %}Performing quality inspection
                  {% elif order.status == 'ready_dispatch' %}Packaged and ready to ship
                  {% elif order.status == 'dispatched' %}Order sent to customer
                  {% elif order.status == 'awaiting_payment' %}Delivered, waiting for payment
                  {% elif order.status == 'completed' %}Order finalized and paid
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Progress Steps -->
          <div class="progress-steps">
            <div class="progress-step {% if order.status == 'in_progress' %}active{% elif order.status in ['confirmed_received', 'processing', 'finished', 'quality_check', 'ready_dispatch', 'dispatched', 'awaiting_payment', 'completed'] %}completed{% endif %}">
              <div class="step-icon">üì•</div>
              <div class="step-label">Accepted</div>
            </div>
            <div class="progress-step {% if order.status == 'confirmed_received' %}active{% elif order.status in ['processing', 'finished', 'quality_check', 'ready_dispatch', 'dispatched', 'awaiting_payment', 'completed'] %}completed{% endif %}">
              <div class="step-icon">‚úÖ</div>
              <div class="step-label">Confirmed</div>
            </div>
            <div class="progress-step {% if order.status == 'processing' %}active{% elif order.status in ['finished', 'quality_check', 'ready_dispatch', 'dispatched', 'awaiting_payment', 'completed'] %}completed{% endif %}">
              <div class="step-icon">üñ®Ô∏è</div>
              <div class="step-label">Processing</div>
            </div>
            <div class="progress-step {% if order.status == 'finished' %}active{% elif order.status in ['quality_check', 'ready_dispatch', 'dispatched', 'awaiting_payment', 'completed'] %}completed{% endif %}">
              <div class="step-icon">‚úîÔ∏è</div>
              <div class="step-label">Finished</div>
            </div>
            <div class="progress-step {% if order.status == 'quality_check' %}active{% elif order.status in ['ready_dispatch', 'dispatched', 'awaiting_payment', 'completed'] %}completed{% endif %}">
              <div class="step-icon">üîç</div>
              <div class="step-label">Quality Check</div>
            </div>
            <div class="progress-step {% if order.status == 'ready_dispatch' %}active{% elif order.status in ['dispatched', 'awaiting_payment', 'completed'] %}completed{% endif %}">
              <div class="step-icon">üì¶</div>
              <div class="step-label">Ready</div>
            </div>
            <div class="progress-step {% if order.status == 'dispatched' %}active{% elif order.status in ['awaiting_payment', 'completed'] %}completed{% endif %}">
              <div class="step-icon">üöö</div>
              <div class="step-label">Dispatched</div>
            </div>
            <div class="progress-step {% if order.status == 'awaiting_payment' %}active{% elif order.status == 'completed' %}completed{% endif %}">
              <div class="step-icon">üí∞</div>
              <div class="step-label">Payment</div>
            </div>
            <div class="progress-step {% if order.status == 'completed' %}active completed{% endif %}">
              <div class="step-icon">üéâ</div>
              <div class="step-label">Completed</div>
            </div>
          </div>

          <!-- Status Update Forms -->
          {% if order.status == 'in_progress' %}
          <div class="status-update-section">
            <form method="POST" action="{{ url_for('vendor_update_status', order_id=order.id) }}" style="margin-bottom: 16px;">
              {{ form.hidden_tag() }}
              <input type="hidden" name="new_status" value="confirmed_received"/>
              <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea name="notes" id="notes" placeholder="Add any notes about receiving the order..." rows="2" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width:100%;">‚úÖ Confirm Order Received</button>
            </form>
          </div>
          {% elif order.status == 'confirmed_received' %}
          <div class="status-update-section">
            <form method="POST" action="{{ url_for('vendor_update_status', order_id=order.id) }}">
              {{ form.hidden_tag() }}
              <input type="hidden" name="new_status" value="processing"/>
              <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea name="notes" id="notes" placeholder="Add notes about starting production..." rows="2" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width:100%;">üñ®Ô∏è Start Processing</button>
            </form>
          </div>
          {% elif order.status == 'processing' %}
          <div class="status-update-section">
            <form method="POST" action="{{ url_for('vendor_update_status', order_id=order.id) }}">
              {{ form.hidden_tag() }}
              <input type="hidden" name="new_status" value="finished"/>
              <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea name="notes" id="notes" placeholder="Add notes about completion..." rows="2" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
              </div>
              <button type="submit" class="btn btn-success" style="width:100%;">‚úîÔ∏è Mark as Finished</button>
            </form>
          </div>
          {% elif order.status == 'finished' %}
          <div class="status-update-section">
            <form method="POST" action="{{ url_for('vendor_update_status', order_id=order.id) }}">
              {{ form.hidden_tag() }}
              <input type="hidden" name="new_status" value="quality_check"/>
              <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea name="notes" id="notes" placeholder="Add quality check notes..." rows="2" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width:100%;">üîç Quality Check Complete</button>
            </form>
          </div>
          {% elif order.status == 'quality_check' %}
          <div class="status-update-section">
            <form method="POST" action="{{ url_for('vendor_update_status', order_id=order.id) }}">
              {{ form.hidden_tag() }}
              <input type="hidden" name="new_status" value="ready_dispatch"/>
              <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea name="notes" id="notes" placeholder="Add packaging notes..." rows="2" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
              </div>
              <button type="submit" class="btn btn-success" style="width:100%;">üì¶ Ready for Dispatch</button>
            </form>
          </div>
          {% elif order.status == 'ready_dispatch' %}
          <div class="status-update-section">
            <form method="POST" action="{{ url_for('vendor_update_status', order_id=order.id) }}">
              {{ form.hidden_tag() }}
              <input type="hidden" name="new_status" value="dispatched"/>
              <div class="form-group">
                <label for="notes">Dispatch Details (Optional)</label>
                <textarea name="notes" id="notes" placeholder="Add tracking number or courier details..." rows="2" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width:100%;">üöö Mark as Dispatched</button>
            </form>
          </div>
          {% elif order.status == 'dispatched' %}
          <div class="status-update-section">
            <form method="POST" action="{{ url_for('vendor_update_status', order_id=order.id) }}">
              {{ form.hidden_tag() }}
              <input type="hidden" name="new_status" value="awaiting_payment"/>
              <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea name="notes" id="notes" placeholder="Confirm delivery details..." rows="2" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
              </div>
              <button type="submit" class="btn btn-warning" style="width:100%;">üí∞ Confirm Delivery - Awaiting Payment</button>
            </form>
          </div>
          {% elif order.status == 'awaiting_payment' %}
          <div class="status-update-section">
            <div style="padding:16px; background:#fff3cd; border-radius:8px; margin-bottom:16px;">
              <strong>üí∞ Send Payment Request</strong><br>
              <p style="margin:8px 0; color:#856404;">Order has been delivered. Send M-Pesa payment request to customer's phone.</p>
            </div>
            
            <!-- M-Pesa Payment Request Form -->
            <div id="payment-form-section">
              <div style="padding: 16px; background: linear-gradient(135deg, #1e5631 0%, #2d7a3f 100%); color: white; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">Amount to Request</div>
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 8px;">KSh {{ "{:,.2f}".format(order.total_amount) }}</div>
                <div style="font-size: 13px; opacity: 0.85;">
                  <div style="margin-bottom: 4px;"><strong>Customer:</strong> {{ order.customer.full_name }}</div>
                  <div><strong>Order:</strong> {{ order.order_number }}</div>
                </div>
              </div>

              <form id="mpesa-payment-form" onsubmit="return initiatePayment(event);">
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="phone_number" style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                    üì± Customer's M-Pesa Phone Number
                  </label>
                  <input 
                    type="text" 
                    id="phone_number" 
                    name="phone_number" 
                    placeholder="e.g., 254712345678" 
                    value="{{ order.customer.phone if order.customer.phone else '' }}"
                    pattern="254[0-9]{9}"
                    required
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;"
                    oninput="validatePhoneNumber(this)"
                  />
                  <small style="color: var(--muted); display: block; margin-top: 6px;">
                    Enter customer's M-Pesa number in format: 254XXXXXXXXX
                  </small>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600;">
                  üì≤ Send Payment Request to Customer
                </button>
              </form>
            </div>

            <!-- Payment Processing Section (Hidden Initially) -->
            <div id="payment-processing" style="display: none;">
              <div style="text-align: center; padding: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; border: 4px solid #f3f3f3; border-top: 4px solid var(--purple); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                
                <h3 style="color: var(--purple); margin-bottom: 12px;">‚è≥ Waiting for Customer Payment</h3>
                <p style="color: var(--muted); margin-bottom: 20px;">
                  Payment request sent to customer's phone<br>
                  <strong id="payment-phone"></strong>
                </p>
                
                <div style="padding: 16px; background: #fff3cd; border-radius: 8px; margin-bottom: 20px;">
                  <div style="font-size: 14px; color: #856404; margin-bottom: 8px;">
                    <strong>üì± Customer will:</strong>
                  </div>
                  <ol style="text-align: left; color: #856404; font-size: 13px; line-height: 1.8; margin: 0; padding-left: 20px;">
                    <li>Receive M-Pesa prompt on their phone</li>
                    <li>Enter their M-Pesa PIN</li>
                    <li>Confirm payment of KSh {{ "{:,.2f}".format(order.total_amount) }}</li>
                  </ol>
                </div>

                <div style="padding: 16px; background: #d1ecf1; border-radius: 8px; margin-bottom: 20px;">
                  <div style="font-size: 28px; font-weight: 700; color: #0c5460; margin-bottom: 4px;" id="countdown-timer">‚è≥</div>
                  <div style="font-size: 13px; color: #0c5460;">Waiting for payment confirmation</div>
                </div>

                <p style="font-size: 12px; color: var(--muted);">
                  <em>Customer will receive M-Pesa prompt on their phone. This typically takes 5-30 seconds.</em>
                </p>
                
                <button onclick="manualConfirm()" class="btn btn-secondary" style="padding: 10px 20px; font-size: 14px; margin-top: 10px;">
                  ‚úÖ Manual Confirm (If Payment Received)
                </button>
              </div>
            </div>

            <!-- Payment Success Section (Hidden Initially) -->
            <div id="payment-success" style="display: none;">
              <div style="text-align: center; padding: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: #198754; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white;">
                  ‚úì
                </div>
                
                <h3 style="color: #198754; margin-bottom: 12px;">‚úÖ Payment Received!</h3>
                <p style="color: var(--muted); margin-bottom: 20px;">
                  Customer payment of <strong>KSh {{ "{:,.2f}".format(order.total_amount) }}</strong> confirmed.
                </p>
                
                <div style="padding: 16px; background: #d1e7dd; border-radius: 8px; margin-bottom: 20px;">
                  <div style="font-size: 13px; color: #0f5132; line-height: 1.8;">
                    <strong>Transaction Details:</strong><br>
                    Reference: <span id="payment-reference"></span><br>
                    Phone: <span id="payment-phone-display"></span><br>
                    Order: {{ order.order_number }}<br>
                    Customer: {{ order.customer.full_name }}
                  </div>
                </div>

                <form method="POST" action="{{ url_for('vendor_confirm_payment', order_id=order.id) }}">
                  {{ form.hidden_tag() }}
                  <input type="hidden" name="payment_reference" id="payment_reference_input" value="">
                  <input type="hidden" name="phone_number" id="phone_number_input" value="">
                  <button type="submit" class="btn btn-success" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600;">
                    ‚úÖ Complete Order
                  </button>
                </form>
              </div>
            </div>
          </div>
          {% elif order.status == 'completed' %}
          <div class="alert-success" style="padding:16px; background:#d1e7dd; border-radius:8px; margin-top:16px;">
            <strong>üéâ Order Completed!</strong><br>
            Payment received and order finalized. Well done!
          </div>
          {% endif %}

          <!-- Customer Files -->
          {% for item in order.order_items %}
            {% if item.file_name %}
            <div style="margin-top:20px; padding:16px; background:#f5f3f8; border-radius:8px;">
              <h4 style="margin:0 0 12px; color:var(--purple);">üìé Customer Files</h4>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <strong>{{ item.file_name }}</strong><br>
                  <small style="color:#6b6b77;">{{ item.service_category }} - {{ item.service_type }}</small>
                </div>
                <a href="{{ url_for('download_order_file', order_id=order.id, item_id=item.id) }}" class="btn btn-secondary" style="padding:8px 16px; font-size:13px;">Download</a>
              </div>
              {% if item.specifications %}
              <div style="margin-top:12px; padding:10px; background:white; border-radius:6px;">
                <strong>Specifications:</strong> {{ item.specifications }}
              </div>
              {% endif %}
            </div>
            {% endif %}
          {% endfor %}
          
          <!-- Order History -->
          {% if order.status_history %}
          <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid #e8e6f2;">
            <h3 style="margin-bottom: 16px; color: var(--purple);">üìã Order History</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              {% for history in order.status_history|reverse %}
              <div style="padding: 12px; background: white; border-radius: 8px; border-left: 4px solid {% if history.changed_by_type == 'vendor' %}var(--purple){% else %}#6b6b77{% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                  <div style="font-weight: 600; color: #333;">{{ history.new_status.replace('_', ' ').title() }}</div>
                  <div style="font-size: 12px; color: var(--muted);">{{ history.created_at.strftime('%b %d, %I:%M %p') }}</div>
                </div>
                {% if history.notes %}
                <div style="font-size: 14px; color: #6b6b77; margin-top: 4px;">{{ history.notes }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      {% elif order.is_quote_deadline_passed %}
        <p class="text-muted">The quote deadline has passed.</p>
      {% elif order.vendor_id %}
        <p class="text-muted">This order has been assigned to another vendor.</p>
      {% endif %}
    </div>
  </div>
</section>

<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .order-detail-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }
  
  .order-header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
  }
  
  .order-header-section h1 {
    margin: 0 0 8px 0;
    font-size: 28px;
  }
  
  .processing-workflow {
    width: 100%;
  }

  .progress-steps {
    display: flex;
    justify-content: space-between;
    margin: 24px 0;
    position: relative;
  }

  .progress-steps::before {
    content: '';
    position: absolute;
    top: 25px;
    left: 50px;
    right: 50px;
    height: 3px;
    background: #e8e6f2;
    z-index: 0;
  }

  .progress-step {
    flex: 1;
    text-align: center;
    position: relative;
    z-index: 1;
  }

  .step-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e8e6f2;
    color: #6b6b77;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    font-size: 24px;
    border: 4px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .progress-step.active .step-icon {
    background: var(--purple);
    color: white;
    box-shadow: 0 0 0 4px rgba(107,33,168,0.2);
  }

  .progress-step.completed .step-icon {
    background: #198754;
    color: white;
  }

  .step-label {
    font-size: 13px;
    font-weight: 600;
    color: #6b6b77;
  }

  .progress-step.active .step-label {
    color: var(--purple);
  }

  .progress-step.completed .step-label {
    color: #198754;
  }

  .status-update-section {
    margin-top: 24px;
    padding: 20px;
    background: #faf9fc;
    border-radius: 12px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  .alert-info {
    text-align: center;
  }

  .alert-success {
    text-align: center;
  }
  
  .badge {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .badge-pending {
    background: #e3f2fd;
    color: #1976d2;
  }
  
  .badge-awaiting_vendor,
  .badge-quoted,
  .badge-quote_revised {
    background: #fff3e0;
    color: #f57c00;
  }
  
  .badge-accepted,
  .badge-in_progress,
  .badge-ready,
  .badge-dispatched {
    background: #e8f5e9;
    color: #388e3c;
  }
  
  .badge-completed {
    background: #f3e5f5;
    color: #7b1fa2;
  }
  
  .order-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }
  
  .card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
  }
  
  .card h2 {
    font-size: 20px;
    margin: 0 0 20px 0;
    padding-bottom: 12px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .info-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
  }
  
  .info-row:last-child {
    border-bottom: none;
  }
  
  .label {
    font-weight: 600;
    color: #666;
  }
  
  .value {
    color: #333;
    text-align: right;
  }
  
  .items-table {
    overflow-x: auto;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  thead {
    background: #f9f9f9;
  }
  
  th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #e0e0e0;
  }
  
  td {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .spec-row td {
    background: #fafafa;
    font-size: 13px;
    color: #666;
  }
  
  tfoot tr {
    font-weight: 600;
  }
  
  .total-row {
    background: #f9f9f9;
  }
  
  .total-row td {
    font-size: 16px;
    color: var(--purple);
  }
  
  .action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-primary {
    background: var(--purple);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--dark-purple);
  }
  
  .btn-secondary {
    background: #f5f5f5;
    color: #333;
  }
  
  .btn-secondary:hover {
    background: #e0e0e0;
  }
  
  .text-muted {
    color: #999;
    font-style: italic;
  }
  
  @media (max-width: 768px) {
    .order-header-section {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    
    .order-grid {
      grid-template-columns: 1fr;
    }
    
    table {
      font-size: 13px;
    }
    
    th, td {
      padding: 8px;
    }
  }
</style>

<script>
function validatePhoneNumber(input) {
  // Remove any non-digit characters
  let value = input.value.replace(/\D/g, '');
  
  // Ensure it starts with 254
  if (value.length > 0 && !value.startsWith('254')) {
    if (value.startsWith('0')) {
      value = '254' + value.substring(1);
    } else if (value.startsWith('7') || value.startsWith('1')) {
      value = '254' + value;
    }
  }
  
  // Limit to 12 digits
  if (value.length > 12) {
    value = value.substring(0, 12);
  }
  
  input.value = value;
}

function initiatePayment(event) {
  event.preventDefault();
  
  const phoneNumber = document.getElementById('phone_number').value;
  
  // Validate phone number format
  if (!/^254[0-9]{9}$/.test(phoneNumber)) {
    alert('Please enter a valid phone number in format: 254XXXXXXXXX');
    return false;
  }
  
  // Store phone number for later
  document.getElementById('phone_number_input').value = phoneNumber;
  
  // Hide form, show processing
  document.getElementById('payment-form-section').style.display = 'none';
  document.getElementById('payment-processing').style.display = 'block';
  
  // Display phone number
  document.getElementById('payment-phone').textContent = phoneNumber;
  
  // Call backend to initiate STK Push
  fetch('{{ url_for("vendor_initiate_payment", order_id=order.id) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'{% if form.csrf_token %},
      'X-CSRFToken': '{{ form.csrf_token._value() }}'{% endif %}
    },
    body: JSON.stringify({ phone_number: phoneNumber })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // STK Push sent successfully - start monitoring
      document.getElementById('countdown-timer').textContent = '‚è≥';
      document.querySelector('#payment-processing p').innerHTML = 
        'Payment request sent to customer\'s phone<br><strong>' + phoneNumber + '</strong><br><em>Waiting for customer to complete payment...</em>';
      
      // Store checkout request ID
      window.checkoutRequestId = data.checkout_request_id;
      
      // In production, you would poll the backend to check payment status
      // For now, we'll use a 60-second timeout
      setTimeout(() => {
        // In production, check actual payment status via callback
        // For testing, you can manually confirm payment
        alert('Payment timeout. Please check if customer completed payment and confirm manually.');
      }, 60000);
      
    } else {
      // Error sending STK Push
      alert('Error: ' + data.message);
      document.getElementById('payment-processing').style.display = 'none';
      document.getElementById('payment-form-section').style.display = 'block';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to send payment request. Please try again.');
    document.getElementById('payment-processing').style.display = 'none';
    document.getElementById('payment-form-section').style.display = 'block';
  });
  
  return false;
}

function manualConfirm() {
  const phoneNumber = document.getElementById('phone_number_input').value;
  const reference = prompt('Enter M-Pesa transaction code (e.g., SH12XYZ9AB):');
  
  if (reference && reference.trim()) {
    completePayment(phoneNumber, reference.trim());
  }
}

function completePayment(phoneNumber, reference) {
  // Store reference
  document.getElementById('payment-reference').textContent = reference || 'MANUAL_CONFIRM';
  document.getElementById('payment_reference_input').value = reference || 'MANUAL_CONFIRM';
  document.getElementById('payment-phone-display').textContent = phoneNumber;
  
  // Hide processing, show success
  document.getElementById('payment-processing').style.display = 'none';
  document.getElementById('payment-success').style.display = 'block';
}
</script>
{% endblock %}
